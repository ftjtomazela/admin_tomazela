<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servi√ßos do Dia - Aprova√ß√£o</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom, #004e92 0%, #000428 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        .admin-nav { 
            background: #111827; padding: 12px 20px; margin-bottom: 20px;
            border-bottom: 2px solid #007bff; display: flex; gap: 10px;
            align-items: center; flex-wrap: wrap;
        }
        .nav-btn { background: #374151; color: #f3f4f6; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; cursor: pointer; text-decoration: none; transition: all 0.3s; font-family: inherit; }
        .nav-btn:hover { background: #4b5563; }
        .nav-btn.active { background: #007bff; color: #fff; } 
        .nav-btn.logout { background: #dc2626; color: #fff; margin-left: auto; }
        .nav-btn.logout:hover { background: #ef4444; }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #007bff; }
        .header h1 { font-size: 2.5rem; color: #fff; }

        #lista-pendentes { list-style: none; padding: 0; display: grid; gap: 20px; }
        .card-item {
            background: #2d3748; border-radius: 12px; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .card-visita { border-left: 5px solid #f59e0b; } 
        .card-pdv { border-left: 5px solid #00bfff; } 
        
        .card-item h3 { color: #fff; margin-bottom: 5px; }
        .card-item p { color: #9ca3af; font-size: 0.9rem; margin-bottom: 3px; }
        .card-item strong { color: #10b981; }
        .card-info { flex-grow: 1; padding-right: 15px; } 
        
        .card-actions { 
            display: flex; flex-direction: column; gap: 8px; /* Coluna para caber mais bot√µes */
            min-width: 150px; /* Garante que os bot√µes caibam */
        }
        
        .btn-aprovar {
            background: #10b981; color: #fff; border: none;
            padding: 8px 12px; border-radius: 8px; cursor: pointer;
            font-weight: bold; transition: background 0.3s;
        }
        .btn-aprovar:hover { background: #059669; }

        .btn-excluir {
            background: #dc2626; color: #fff; border: none;
            padding: 8px 12px; border-radius: 8px; cursor: pointer;
            font-weight: bold; transition: background 0.3s;
        }
        .btn-excluir:hover { background: #ef4444; }
        
        /* ‚≠ê NOVOS ESTILOS PARA PDV ‚≠ê */
        .btn-recibo {
            background: #007bff; /* Azul para Recibo */
            color: #fff; border: none;
            padding: 8px 12px; border-radius: 8px; cursor: pointer;
            font-weight: bold; transition: background 0.3s;
        }
        .btn-recibo:hover { background: #0056b3; }
        
        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #2d3748; margin: 10% auto; padding: 20px;
            border: 1px solid #4b5563; width: 80%; max-width: 500px;
            border-radius: 12px;
        }
        .modal-content h2 { color: #007bff; margin-bottom: 15px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: #fff; text-decoration: none; cursor: pointer; }
        
        /* Estilo da "Notinha" */
        #recibo-content { 
            background: #fff; color: #000; padding: 15px; border-radius: 8px; 
            font-family: monospace; font-size: 0.85rem; line-height: 1.4;
            white-space: pre-wrap; /* Mant√©m a formata√ß√£o de nova linha */
        }
        
        .recibo-actions { margin-top: 15px; display: flex; gap: 10px; }
        .recibo-actions button { padding: 10px; border-radius: 8px; cursor: pointer; }
        .btn-whatsapp { background: #25d366; color: #fff; border: none; }
        .btn-print { background: #6c757d; color: #fff; border: none; }
        
        /* Esconde a interface de admin ao imprimir */
        @media print {
            body > *:not(.modal-content), .modal-content .close-btn, .recibo-actions { display: none !important; }
            .modal { position: static; background: none; }
            .modal-content { 
                margin: 0; width: 100%; max-width: none; border: none; 
                background: #fff; color: #000; padding: 0;
            }
            #recibo-content { 
                padding: 0; margin: 0; width: 100%; 
                font-size: 11pt; 
                color: #000; 
                white-space: pre-wrap;
            }
        }
    </style>
</head>
<body>
<div class="admin-nav">
    <a href="admin_piscina.html" class="nav-btn">üè† Painel</a>
    <a href="clientes.html" class="nav-btn">üë• Clientes</a>
    <a href="produtos.html" class="nav-btn">üì¶ Produtos</a>
    
    <a href="ficha_visita.html" class="nav-btn">üìù Ficha de Visita</a>
    <a href="pdv_piscina.html" class="nav-btn">‚úçÔ∏è PDV</a>

    <a href="servicos_do_dia.html" class="nav-btn">üìã Aprova√ß√£o/Servi√ßos</a>
    <a href="pedidos_finalizados.html" class="nav-btn">üí∞ Pedidos Finalizados</a>
    <a href="faturamento.html" class="nav-btn">üí≤ Faturamento</a>
    <a href="recebimentos.html" class="nav-btn">üí≤ Recebimentos</a>
    
    <a href="gerenciar_visitas.html" class="nav-btn">üõ†Ô∏è Gerenciar Visitas</a>
    <a href="empresa.html" class="nav-btn">üè¢ Configura√ß√µes</a>
    
    <button id="logout-btn" class="nav-btn logout">Sair ‚ûî</button>
</div>

    <div class="container">
        <div class="header">
            <h1>üìã Aprova√ß√£o de Fichas e Pedidos</h1>
            <p id="msg-status" style="color: #f59e0b; margin-top: 10px;">Carregando itens pendentes...</p>
        </div>

        <ul id="lista-pendentes">
            </ul>
    </div>
    
    <div id="reciboModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModal()">&times;</span>
            <h2>Recibo de Venda</h2>
            <div id="recibo-content">
                </div>
            <div class="recibo-actions">
                <button class="btn-whatsapp" onclick="enviarWhatsApp()">
                    <img src="whatsapp_icon.png" style="width: 20px; vertical-align: middle;"> Enviar WhatsApp
                </button>
                <button class="btn-print" onclick="imprimirRecibo()">
                    Imprimir
                </button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getDatabase, ref, get, push, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB_2Ssx3a3CW3PEP2RBh7j5TQl1UPuSg4k",
            authDomain: "tomazela-piscinas.firebaseapp.com",
            databaseURL: "https://tomazela-piscinas-default-rtdb.firebaseio.com", 
            projectId: "tomazela-piscinas",
            storageBucket: "tomazela-piscinas.firebasestorage.app", 
            messagingSenderId: "776818671387",
            appId: "1:776818671387:web:ca4211e6fa8f3f1c889dbe",
            measurementId: "G-PP230KYC4X"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        // Refer√™ncias
        const visitasRef = ref(database, 'visitas'); 
        const visitasPendentesRef = ref(database, 'visitas_pendentes'); 
        const pedidosRef = ref(database, 'pedidos'); 
        const pedidosPendentesRef = ref(database, 'pedidos_pendentes'); 

        // Elementos DOM
        const listaPendentes = document.getElementById('lista-pendentes');
        const msgStatus = document.getElementById('msg-status');
        const reciboContent = document.getElementById('recibo-content');
        const reciboModal = document.getElementById('reciboModal');
        
        let pedidoAtualParaRecibo = null; // Vari√°vel global para armazenar o pedido

        // --- VIGIA E LOGOUT ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                carregarTodosPendentes();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', () => {
            if (confirm("Tem certeza que deseja sair?")) {
                signOut(auth);
            }
        });
        
        // --- FUN√á√ïES DE L√ìGICA DE DADOS ---

        async function carregarTodosPendentes() {
            msgStatus.textContent = "Carregando itens pendentes...";
            
            try {
                let todosPendentes = [];
                
                // Carrega Visitas Pendentes
                const visitasSnapshot = await get(visitasPendentesRef);
                if (visitasSnapshot.exists()) {
                    visitasSnapshot.forEach(child => {
                        todosPendentes.push({ id: child.key, ...child.val(), tipo: 'Visita' }); 
                    });
                }
                
                // Carrega Pedidos Pendentes
                const pedidosSnapshot = await get(pedidosPendentesRef);
                if (pedidosSnapshot.exists()) {
                    pedidosSnapshot.forEach(child => {
                        todosPendentes.push({ id: child.key, ...child.val(), tipo: 'PDV' }); 
                    });
                }

                listaPendentes.innerHTML = '';
                
                if (todosPendentes.length > 0) {
                    todosPendentes.sort((a, b) => b.timestamp - a.timestamp);
                    todosPendentes.forEach(item => {
                        renderizarItemPendente(item);
                    });
                    
                    msgStatus.textContent = `Encontrados ${todosPendentes.length} itens (Visitas/Pedidos) para aprova√ß√£o.`;
                    msgStatus.style.color = '#fff';
                    
                } else {
                    msgStatus.textContent = "ü•≥ Nenhum item pendente no momento!";
                    msgStatus.style.color = '#10b981'; 
                }
            } catch (e) {
                console.error("Erro ao carregar itens pendentes: ", e);
                msgStatus.textContent = "‚ùå Erro ao carregar os itens. Verifique as Regras de Permiss√£o do Firebase.";
                msgStatus.style.color = '#dc2626'; 
            }
        }

        function renderizarItemPendente(item) {
            const li = document.createElement('li');
            li.className = `card-item card-${item.tipo.toLowerCase()}`; 
            li.dataset.id = item.id; 

            if (item.tipo === 'Visita') {
                const servicos = item.servicos && item.servicos.length > 0 ? item.servicos.join(', ') : 'Nenhum.';
                const produtosUtilizados = item.produtos || 'Nenhum.';

                li.innerHTML = `
                    <div class="card-info">
                        <h3>Ficha de Visita: ${item.clienteNome}</h3>
                        <p>Data: <strong>${new Date(item.dataVisita).toLocaleDateString('pt-BR')}</strong></p>
                        <p>Par√¢metros: pH: ${item.ph || '-'} | Alcalinidade: ${item.alcalinidade || '-'} | Cloro: ${item.cloro || '-'}</p>
                        <p>Servi√ßos: ${servicos}</p>
                        <p>Produtos Utilizados: <strong>${produtosUtilizados}</strong></p>
                    </div>
                    <div class="card-actions">
                        <button class="btn-excluir" data-id="${item.id}" data-tipo="${item.tipo}">Excluir</button>
                        <button class="btn-aprovar" data-id="${item.id}" data-tipo="${item.tipo}">Aprovar Visita</button>
                    </div>
                `;
                
                li.querySelector('.btn-aprovar').addEventListener('click', () => {
                    const { id: _, ...dadosParaAprovar } = item;
                    aprovarItem(item.id, dadosParaAprovar, li, visitasRef, visitasPendentesRef);
                });

            } else if (item.tipo === 'PDV') {
                
                const valorFormatado = (typeof item.total === 'number' && !isNaN(item.total)) 
                                        ? item.total.toFixed(2).replace('.', ',') 
                                        : '0,00'; 
                
                const nomeCliente = item.cliente && item.cliente.nome ? item.cliente.nome : 'Cliente Desconhecido';

                li.innerHTML = `
                    <div class="card-info">
                        <h3>Pedido PDV: ${nomeCliente}</h3>
                        <p>Data: <strong>${new Date(item.timestamp).toLocaleDateString('pt-BR')}</strong></p>
                        <p>Valor Total: <strong style="color: #00bfff;">R$ ${valorFormatado}</strong></p>
                        <p>Pagamento: <strong>${item.pagamento}</strong></p>
                        <p>Itens: ${item.itens.map(i => `${i.nome} (${i.quantidade}x)`).join(', ')}</p>
                        <p>Obs: ${item.observacoes || 'Nenhuma.'}</p>
                    </div>
                    <div class="card-actions">
                        <button class="btn-recibo" data-id="${item.id}">Ver Recibo</button> 
                        <button class="btn-aprovar" data-id="${item.id}" data-tipo="${item.tipo}">Aprovar Pedido</button>
                        <button class="btn-excluir" data-id="${item.id}" data-tipo="${item.tipo}">Excluir</button>
                    </div>
                `;
                
                // Listener para o bot√£o Recibo (Novo)
                li.querySelector('.btn-recibo').addEventListener('click', () => {
                    abrirModalRecibo(item);
                });
                
                li.querySelector('.btn-aprovar').addEventListener('click', () => {
                    const { id: _, ...dadosParaAprovar } = item;
                    aprovarItem(item.id, dadosParaAprovar, li, pedidosRef, pedidosPendentesRef);
                });
            }

            // Listener para Excluir
            li.querySelector('.btn-excluir').addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                const tipo = e.target.dataset.tipo;
                const nomeCliente = tipo === 'Visita' ? item.clienteNome : (item.cliente ? item.cliente.nome : 'Cliente Desconhecido');
                excluirItem(id, nomeCliente, li, tipo);
            });

            listaPendentes.appendChild(li);
        }

        // Fun√ß√£o gen√©rica para Aprovar (mantida)
        async function aprovarItem(id, dadosItem, elementoLi, refDestino, refOrigem) {
            const nomeItem = dadosItem.tipo === 'Visita' ? 'Ficha de Visita' : 'Pedido PDV';
            const nomeCliente = dadosItem.clienteNome || (dadosItem.cliente ? dadosItem.cliente.nome : 'Cliente'); 
            
            if (!confirm(`Tem certeza que deseja APROVAR o ${nomeItem} de ${nomeCliente}?`)) {
                return;
            }

            const btn = elementoLi.querySelector('.btn-aprovar');
            const btnExcluir = elementoLi.querySelector('.btn-excluir');

            btn.disabled = true;
            btnExcluir.disabled = true;
            btn.textContent = 'Aprovando...';

            try {
                // 1. Salva no n√≥ final
                await push(refDestino, {
                    ...dadosItem,
                    dataAprovacao: new Date().toISOString().split('T')[0],
                    status: 'Aprovado'
                }); 

                // 2. Remove do n√≥ de pendentes
                const pendenteRef = ref(database, `${refOrigem.key}/${id}`);
                await remove(pendenteRef); 
                
                // 3. Feedback visual
                elementoLi.style.transition = '0.5s';
                elementoLi.style.opacity = '0';
                setTimeout(() => {
                    elementoLi.remove();
                    carregarTodosPendentes(); 
                }, 500);

            } catch (e) {
                console.error(`Falha na aprova√ß√£o do ${nomeItem}: `, e);
                alert(`Falha na aprova√ß√£o do ${nomeItem}. Tente novamente.`);
                btn.disabled = false;
                btnExcluir.disabled = false;
                btn.textContent = `Aprovar ${dadosItem.tipo === 'Visita' ? 'Visita' : 'Pedido'}`;
            }
        }
        
        // Fun√ß√£o gen√©rica para Excluir (mantida)
        async function excluirItem(id, clienteNome, elementoLi, tipo) {
            const nomeItem = tipo === 'Visita' ? 'Ficha de Visita' : 'Pedido PDV';
            const refOrigem = tipo === 'Visita' ? visitasPendentesRef : pedidosPendentesRef;
            
            if (!confirm(`ATEN√á√ÉO: Tem certeza que deseja EXCLUIR permanentemente o ${nomeItem} de ${clienteNome}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }
            
            const btnExcluir = elementoLi.querySelector('.btn-excluir');
            const btnAprovar = elementoLi.querySelector('.btn-aprovar');

            btnExcluir.disabled = true;
            btnAprovar.disabled = true;
            btnExcluir.textContent = 'Excluindo...';

            try {
                // Remove o item do n√≥ de pendentes
                const pendenteRef = ref(database, `${refOrigem.key}/${id}`);
                await remove(pendenteRef); 
                
                // Feedback visual
                elementoLi.style.transition = '0.5s';
                elementoLi.style.opacity = '0';
                setTimeout(() => {
                    elementoLi.remove();
                    carregarTodosPendentes(); 
                    alert(`${nomeItem} de ${clienteNome} exclu√≠do com sucesso!`);
                }, 500);

            } catch (e) {
                console.error(`Falha na exclus√£o do ${nomeItem}: `, e);
                alert(`Falha na exclus√£o do ${nomeItem}. Tente novamente.`);
                btnExcluir.disabled = false;
                btnAprovar.disabled = false;
                btnExcluir.textContent = 'Excluir';
            }
        }
        
        // --- FUN√á√ïES DE RECIBO (NOVO) ---
        
        function gerarConteudoRecibo(pedido) {
            const data = new Date(pedido.timestamp).toLocaleDateString('pt-BR');
            const hora = new Date(pedido.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            const nomeCliente = pedido.cliente && pedido.cliente.nome ? pedido.cliente.nome : 'Consumidor Final';
            const valorTotal = (typeof pedido.total === 'number' ? pedido.total.toFixed(2).replace('.', ',') : '0,00');
            
            let recibo = `
========================================
       RECIBO DE VENDA - TOMAZELA
========================================
Data/Hora: ${data} √†s ${hora}
Cliente: ${nomeCliente}
----------------------------------------
PRODUTOS/SERVI√áOS:

`;
            // Lista de Itens
            pedido.itens.forEach(item => {
                const precoUn = (typeof item.precoTotal === 'number' ? item.precoTotal.toFixed(2).replace('.', ',') : '0,00');
                const precoTotalItem = (item.precoTotal * item.quantidade).toFixed(2).replace('.', ',');
                recibo += `${item.quantidade}x ${item.nome}\n`;
                recibo += `  R$ ${precoUn} un. | Total: R$ ${precoTotalItem}\n`;
            });
            
            // Rodap√©
            recibo += `
----------------------------------------
TOTAL: R$ ${valorTotal}
Pagamento: ${pedido.pagamento}
Observa√ß√µes: ${pedido.observacoes || 'Nenhuma.'}
========================================
`;
            return recibo;
        }

        function abrirModalRecibo(pedido) {
            pedidoAtualParaRecibo = pedido;
            reciboContent.textContent = gerarConteudoRecibo(pedido);
            reciboModal.style.display = 'block';
        }

        window.fecharModal = function() {
            reciboModal.style.display = 'none';
            pedidoAtualParaRecibo = null;
        }

        window.enviarWhatsApp = function() {
            if (!pedidoAtualParaRecibo) return;
            
            const mensagem = encodeURIComponent(gerarConteudoRecibo(pedidoAtualParaRecibo));
            // Abre o WhatsApp Web ou App. O URL pode ser 'api' ou 'web'.
            // N√£o inclu√≠mos o n√∫mero do cliente (pedidoAtualParaRecibo.cliente.telefone) pois ele n√£o est√° no objeto PDV, mas seria o ideal.
            const whatsappUrl = `https://api.whatsapp.com/send?text=${mensagem}`;
            
            window.open(whatsappUrl, '_blank');
        }

        window.imprimirRecibo = function() {
            // Usa a fun√ß√£o nativa de impress√£o do navegador, que ser√° formatada pelo CSS @media print
            window.print();
        }

    </script>
</body>
</html>


